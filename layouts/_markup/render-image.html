{{- $url := .Destination -}}
{{- $isRemote := strings.HasPrefix $url "http" -}}

{{- if $isRemote -}}
    {{/* 1. 외부 이미지는 그대로 렌더링 */}}
    <img src="{{ $url }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}"{{ end }}>

{{- else -}}
    {{/* 2. 로컬 이미지 처리 */}}
    {{- $imageResource := "" -}}
    {{- $finalURL := "" -}}
    
    {{- if strings.HasPrefix $url "/" -}}
        {{- /* 2a. /로 시작하는 경로: content 폴더 기준 절대 경로 */}}
        {{- $path := strings.TrimPrefix "/" $url -}}
        {{- $imageResource = resources.Get $path -}}
        {{- if not $imageResource -}}
            {{- $imageResource = site.GetPage $path -}}
        {{- end -}}
    {{- else -}}
        {{- /* 2b. 상대 경로 처리 */}}
        {{- /* 먼저 현재 페이지의 리소스에서 찾기 */}}
        {{- $imageResource = .Page.Resources.GetMatch $url -}}
        
        {{- if not $imageResource -}}
            {{- /* 페이지 리소스에서 못 찾으면 상대 경로 계산 */}}
            {{- $currentPageDir := .Page.File.Dir -}}
            {{- $targetPath := path.Join $currentPageDir $url | path.Clean -}}
            {{- $imageResource = resources.Get $targetPath -}}
            {{- if not $imageResource -}}
                {{- $imageResource = site.GetPage $targetPath -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

    {{- if $imageResource -}}
        {{- /* 3. 리소스를 찾은 경우 */}}
        {{- if reflect.IsMap $imageResource -}}
            {{- /* Page 리소스인 경우 */}}
            {{- $finalURL = $imageResource.RelPermalink -}}
        {{- else -}}
            {{- /* resources.Get으로 찾은 경우 */}}
            {{- $finalURL = $imageResource.RelPermalink -}}
        {{- end -}}
        <img src="{{ $finalURL }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}"{{ end }}>
    {{- else -}}
        {{- /* 4. 리소스를 못 찾은 경우, relURL 사용 (baseURL 서브패스 자동 처리) */}}
        <img src="{{ $url | relURL }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}"{{ end }}>
    {{- end -}}

{{- end -}}