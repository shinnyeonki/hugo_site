---
title: 프로젝트 로그인 기능 구현
date: 2024-11-25T10:56:00+09:00
lastmod: 2024-11-25T10:56:00+09:00
resource-path: temp/프로젝트 로그인 기능 구현.md
aliases: 
tags: 
---
`/test/employee` 뷰를 특정 역할을 가진 로그인된 사용자만 접근할 수 있도록 하려면 인증 및 권한 부여를 구현해야 합니다. 이를 위해 Flask-Login과 역할 기반 액세스 제어(RBAC)를 사용할 수 있습니다.

## 단계별 가이드:

1. **Flask-Login 설치 및 설정**
2. **사용자 모델 생성 및 역할 추가**
3. **로그인 및 로그아웃 기능 구현**
4. **접근 제한 데코레이터 작성**
5. **employee 뷰 보호**

## 1. Flask-Login 설치 및 설정

먼저 Flask-Login을 설치합니다:
`pip install flask-login`
`app.py`에서 Flask-Login을 설정합니다:
```python
from flask import Flask
from flask_login import LoginManager

def create_app():
    app = Flask(__name__)
    app.secret_key = os.urandom(24)

    # Initialize the database
    init_db(app)

    # Initialize Flask-Login
    login_manager = LoginManager()
    login_manager.login_view = 'auth.login'
    login_manager.init_app(app)

    # Register blueprints
    from auth import auth as auth_blueprint
    app.register_blueprint(auth_blueprint)

    import views
    import test_views
    app.register_blueprint(views.main)
    app.register_blueprint(test_views.test)

    return app
```

## 2. 사용자 모델 생성 및 역할 추가

사용자 정보를 저장하고 역할을 관리하기 위한 모델을 생성합니다.
```python
from flask_login import UserMixin

class User(UserMixin):
    def __init__(self, id, username, role):
        self.id = id
        self.username = username
        self.role = role
```

사용자 정보를 데이터베이스에서 가져오는 함수도 필요합니다:

```python
from flask_login import LoginManager
from models import User

login_manager = LoginManager()

@login_manager.user_loader
def load_user(user_id):
    # 데이터베이스에서 사용자 정보 가져오기
    cursor = g.db.cursor()
    cursor.execute("SELECT id, username, role FROM users WHERE id = :id", {'id': user_id})
    result = cursor.fetchone()
    if result:
        return User(id=result[0], username=result[1], role=result[2])
    return None
```

## 3. 로그인 및 로그아웃 기능 구현

`auth` 블루프린트를 생성하여 인증 관련 뷰를 관리합니다.
```python
from flask import Blueprint, render_template, redirect, url_for, request, flash
from flask_login import login_user, logout_user
from models import User

auth = Blueprint('auth', __name__)

@auth.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        # 데이터베이스에서 사용자 인증
        cursor = g.db.cursor()
        cursor.execute("SELECT id, username, role FROM users WHERE username = :username AND password = :password", {'username': username, 'password': password})
        result = cursor.fetchone()
        if result:
            user = User(id=result[0], username=result[1], role=result[2])
            login_user(user)
            return redirect(url_for('test.employee'))
        else:
            flash('Invalid credentials', 'error')
    return render_template('login.html')

@auth.route('/logout')
def logout():
    logout_user()
    return redirect(url_for('auth.login'))
```

## 4. 접근 제한 데코레이터 작성

특정 역할을 가진 사용자만 접근할 수 있도록 데코레이터를 작성합니다.
```python
from flask import redirect, url_for, flash
from flask_login import current_user
from functools import wraps

def role_required(role):
    def wrapper(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated:
                flash('You need to be logged in to access this page.', 'error')
                return redirect(url_for('auth.login'))
            if current_user.role != role:
                flash('You do not have permission to access this page.', 'error')
                return redirect(url_for('auth.login'))
            return f(*args, **kwargs)
        return decorated_function
    return wrapper
```

## 5. employee 뷰 보호

employee 뷰에 데코레이터를 적용하여 역할 기반 접근을 제어합니다.
```python
from decorators import role_required
from flask_login import login_required

@test.route('/test/employee', methods=['GET', 'POST'])
@login_required
@role_required('2')  # '2'가 경영관리 직원의 역할 코드라고 가정
def employee():
    # 기존 코드 그대로
    ...
```


## 추가 사항

- **데이터베이스에 사용자 및 역할 테이블 추가**: 사용자 정보를 저장하기 위한 테이블을 데이터베이스에 생성해야 합니다.
- **비밀번호 보안 처리**: 실제로는 비밀번호를 평문으로 저장하지 않고 해싱하여 저장해야 합니다.
- **로그인 템플릿 작성**: `login.html` 템플릿을 생성하여 로그인 폼을 제공합니다.

---

이렇게 하면 `/test/employee` 뷰는 로그인된 사용자 중에서 역할이 `'2'`인 사용자만 접근할 수 있게 됩니다. 필요한 경우 역할 비교 부분을 수정하여 정확한 역할 이름이나 코드를 사용하세요.